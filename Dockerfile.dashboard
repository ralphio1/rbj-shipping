FROM karrio/dashboard:latest

# Install sed for runtime URL replacement
RUN apk add --no-cache sed

# Create startup script to replace hardcoded URLs
RUN echo '#!/bin/sh' > /usr/local/bin/start-dashboard.sh && \
    echo 'echo "ðŸ”§ Configuring dashboard API URLs..."' >> /usr/local/bin/start-dashboard.sh && \
    echo 'find /app -name "*.js" -o -name "*.json" -o -name "*.html" | xargs sed -i "s|https://api\.karrio\.io|https://karrio-api.onrender.com|g" 2>/dev/null || true' >> /usr/local/bin/start-dashboard.sh && \
    echo 'find /app -name "*.js" -o -name "*.json" -o -name "*.html" | xargs sed -i "s|http://api\.karrio\.io|https://karrio-api.onrender.com|g" 2>/dev/null || true' >> /usr/local/bin/start-dashboard.sh && \
    echo 'find /app -name "*.js" -o -name "*.json" -o -name "*.html" | xargs sed -i "s|http://localhost:5002|https://karrio-api.onrender.com|g" 2>/dev/null || true' >> /usr/local/bin/start-dashboard.sh && \
    echo 'echo "âœ… Dashboard configured to use: https://karrio-api.onrender.com"' >> /usr/local/bin/start-dashboard.sh && \
    echo 'exec "$@"' >> /usr/local/bin/start-dashboard.sh

RUN chmod +x /usr/local/bin/start-dashboard.sh

# Set environment variables for good measure
ENV KARRIO_PUBLIC_URL=https://karrio-api.onrender.com
ENV DASHBOARD_URL=https://karrio-dashboard.onrender.com
ENV NEXT_PUBLIC_KARRIO_API_URL=https://karrio-api.onrender.com
ENV KARRIO_API_URL=https://karrio-api.onrender.com

ENTRYPOINT ["/usr/local/bin/start-dashboard.sh"]
